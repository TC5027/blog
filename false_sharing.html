<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="on-a-use-of-the-repr-attribute-in-rust">On a use of the “repr” attribute in Rust</h1>
<p>Consider we work with the following struct representing a counter,</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">struct</span> <span class="token function">Counter</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>and we want to increment it with random <code>u8</code> values with the help of a for loop :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">use</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span>Rng<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
		counter<span class="token number">.0</span> <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This takes 1.90ms to run on my laptop using <code>cargo run --release</code>. Remember this timing as it will be our reference value :)<br>
Now suppose we were given this struct, holding not 1 but 2 counters :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">struct</span> Counters <span class="token punctuation">{</span>
	c1 <span class="token punctuation">:</span> u64<span class="token punctuation">,</span>
	c2 <span class="token punctuation">:</span> u64
<span class="token punctuation">}</span>
</code></pre>
<p>Using the same approach, performing the increments for the 2 counters in a single-threaded fashion, we would expect to be twice slower (in fact it takes 3.71ms to execute).<br>
Can we do better ? Well, as our 2 counters are independent, we could spawn 2 threads, assign them one counter and increment concurrently ! Given I have 4 CPUs on my laptop, I would expect to be just as fast as the first scenario. Let’s see !</p>
<p>First thing, we could create a local variable in each thread which would be incremented and then we would set the counter value to this incremented one (spoiler : good idea). But we could also save these 2 variables and share the <code>Counter</code> between the 2 threads with an <code>Arc</code> (spoiler : definitely not worth). Let’s do this second option ! ^^</p>
<p>Doing the following code,</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> counters <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Counters<span class="token punctuation">{</span>c1<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> c2<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> counters_clone <span class="token operator">=</span> counters<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">let</span> handler1 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
			counters<span class="token punctuation">.</span>c1 <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> handler2 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
			counters_clone<span class="token punctuation">.</span>c2 <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	handler1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> handler2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>we end up with an error :</p>
<p><strong>cannot assign to data in an <code>Arc</code></strong><br>
<strong>cannot assign</strong><br>
<strong>help: trait <code>DerefMut</code> is required to modify through a dereference, but it is not implemented for <code>std::sync::Arc&lt;Counters&gt;</code>rustc(E0594)</strong></p>
<p>Unlucky. Maybe we could use <strong>atomic types</strong>. These types provide operations that synchronize updates between threads. In fact, as an equivalent of <code>+=</code> we could use the <code>fetch_add</code> method which has the following signature : <code>pub fn fetch_add(&amp;self, val: u64, order: Ordering) -&gt; u64</code>. What should be highlighted is the <code>&amp;self</code>. We could expect a <code>&amp;mut self</code> given the modification we want to perform using it but thanks to the property that an atomic operation is performed without interruptions we don’t need exclusive access to the variable to safely update it.<br>
We can solve the error replacing the counter’s type by <code>AtomicU64</code> as like that we only require <code>Arc</code> to implement the <code>Deref</code> trait (given the signature of <code>fetch_add</code>) and it is the case !</p>
<p>We so have to change a bit our struct to :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">struct</span> Counters <span class="token punctuation">{</span>
	c1 <span class="token punctuation">:</span> AtomicU64<span class="token punctuation">,</span>
	c2 <span class="token punctuation">:</span> AtomicU64<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>and our code to :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> counters <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Counters<span class="token punctuation">{</span>
        c1 <span class="token punctuation">:</span>  AtomicU64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        c2 <span class="token punctuation">:</span> AtomicU64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> counters_clone <span class="token operator">=</span> counters<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handler1 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
            counters<span class="token punctuation">.</span>c1<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">,</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> handler2 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
            counters_clone<span class="token punctuation">.</span>c2<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">,</span>Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>handler2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We could naturally expect the operation on Atomics to be a bit slower than the ones on <code>u64</code> but let’s see !<br>
30.22ms … ok… that’s terrible ^^<br>
Do Atomics operations explain all this ?<br>
I ran a benchmark to compare <code>+=</code> and <code>fetch_add( ,Relaxed)</code> to figure it out :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> start <span class="token operator">=</span> Instant<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10_000_000</span> <span class="token punctuation">{</span>
	sum <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"time spent u64 sum : {:?}"</span><span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> atomic_sum <span class="token operator">=</span> AtomicU64<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> start <span class="token operator">=</span> Instant<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10_000_000</span> <span class="token punctuation">{</span>
	atomic_sum<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">,</span> Relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"time spent AtomicU64 sum : {:?}"</span><span class="token punctuation">,</span> start<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The <code>u64</code> sums takes 20.07ms while the <code>AtomicU64</code> one takes 70.28ms. So we should only be 3 times slower than 2ms but we are 15 times slower how can it be ???</p>
<p>Hint : CPU cache… but why should we care ?<br>
CPU cache is a data storage, located close to CPU, offering a fast access to data.<br>
In a computer, when the CPU needs to read or write a value, it checks if it is present inside the cache or not. If it is the case then the CPU directly uses the cached data. Otherwise, the cache allocates a new entry and copies data from main memory, an entry being of fixed size and called <em>cache line</em>.<br>
CPU cache is relatively small compared to RAM but much faster, and that’s why a program should be designed to use as much as possible data lying in cache, based on a locality principle, to avoid expensive access to RAM.</p>
<p>If we represent our current situation it looks like this<br>
<img src="http://image.noelshack.com/fichiers/2021/38/7/1632663848-schema.png" alt="figure"></p>
<p>The red square corresponds to the first counter and the green one to the second. They can potentially lie in the same cache line !</p>
<p>If data is modified through CPU 0 in its L1 cache we expect our computer to reflect the changes both in memory and in the other L1 cache. To ensure this coherency, there exists coherence protocols which can force the <strong>whole cache line</strong> impacted by the change to be propagated through the whole system, in order to update the copies of the value changed.</p>
<p>With that in mind, what is happening in our code comes from that : we suffer from coherency protocol due to our 2 counters lying on the same cache line. Updating first counter through CPU 0 involves an update in the system of the data stored in the cache line where the second counter (unchanged) potentially lies. During this update, CPU 1 cannot access the second counter whereas it is clearly independent from the change made by CPU 0, and that’s why we are slow.<br>
How can we solve then ? well by making sure that the counters lie on different cache lines and that’s where we can use the <code>repr</code> attribute.</p>
<p>In Rust, we can specify the alignment we want for our type with the <code>repr(align)</code> attribute. We use it like this :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token attribute attr-name">#[repr(align(64))]</span>
<span class="token keyword">struct</span> <span class="token function">CachePadded</span><span class="token punctuation">(</span>AtomicU64<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>A data of alignment X is stored in memory at address multiple of X. Knowing this, giving to our counters an alignment equal to the size of a cache line, we ensure that the 2 counters won’t be stored in the same cache line !</p>
<p>We can get the size of cache lines with command <code>getconf LEVEL1_DCACHE_LINESIZE</code>. On my laptop the output value is 64.</p>
<p>With those changes we have now a timing of 7.16ms which seems decent given we work with Atomics. Mission succeeded !</p>
<p>Finally given my remark at the beginning, I wanted to share a potentially better solution, using local variables in the threads, and channels to communicate these local variables back to the main thread :</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>mpsc<span class="token punctuation">:</span><span class="token punctuation">:</span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>s1<span class="token punctuation">,</span>t1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>s2<span class="token punctuation">,</span>t2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> h1 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> local_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
            local_counter <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        s1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>local_counter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> h2 <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> local_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> rand<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">{</span>
            local_counter <span class="token operator">+=</span> rng<span class="token punctuation">.</span>gen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">&lt;</span>u8<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> u64<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        s2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>local_counter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    h1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    h2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span> Counters<span class="token punctuation">{</span>c1<span class="token punctuation">:</span> t1<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>c2<span class="token punctuation">:</span> t2<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It takes 2.03 ms to execute :)</p>
</div>
</body>

</html>
